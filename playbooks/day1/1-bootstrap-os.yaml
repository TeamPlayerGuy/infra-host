---
- name: Bootstrap Raspberry Pi for Kubernetes
  hosts: k8s_new_workers
  tasks:
    - name: Disable swap
      command: swapoff -a
      register: swapoff_result
      changed_when: ansible_swaptotal_mb | int > 0
      when: ansible_swaptotal_mb | int > 0

    - name: Remove swap entry from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^\s*([^#]\S+\s+\S+\s+swap\s+.*)$'
        replace: '# \1'
      when: swapoff_result is changed

    - name: Enable kernel modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: Ensure kernel modules persist after reboot
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: Ensure sysctl settings for Kubernetes Networking
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-ip6tables = 1
          net.bridge.bridge-nf-call-iptables = 1
          net.ipv4.ip_forward = 1

    - name: Apply sysctl settings
      command: sudo sysctl --system

    - name: Configure fan controls

    - name: Install OhMyBash

    - name: Harden SSH

    - name: Install required packages

      loop:
        - containerd.io # Container Runtime we'll be using
        - avahi-daemon # Enables host.local mDNS
        - apt-transport-https # Enable apt to fetch over HTTPS
        - ca-certificates # Ensures system can validate secure package downloads
        - curl
        - gpg # GNU Privacy Guard required to import Kube keyring
        - kubelet # Kubernetes
        - kubeadm # Kubernetes
        - kubectl # Kubernetes
        - device-tree-compiler # Required to compile boot loader after edit
        - nfs-common # Required by Longhorn
        - open-iscsi # Required by Longhorn

    - name: Reboot and Validate
